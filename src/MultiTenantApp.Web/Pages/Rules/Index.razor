@page "/rules"
@attribute [Authorize(Roles = "Admin, Rules")]
@using MultiTenantApp.Web.Services
@using MultiTenantApp.Web
@using MultiTenantApp.Web.Resources.Pages
@using MultiTenantApp.Web.Resources
@using RulesRes = MultiTenantApp.Web.Resources.Pages.Rules

@inject IRuleService RuleService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">@RulesRes.RulesManagementTitle</MudText>

<MudButton Variant="Variant.Filled" 
          Color="Color.Primary" 
          StartIcon="@Icons.Material.Filled.Add"
          Href="/rules/create"
          Class="mb-4">
    @RulesRes.AddRuleButton
</MudButton>

<MudDataGrid T="RuleDto"
             ServerData="LoadServerData"
             @ref="dataGrid"
             Filterable="false"
             SortMode="SortMode.Single"
             Elevation="2">
    <Columns>
        <PropertyColumn Property="x => x.Name" Title="@SharedResource.Name" />
        <PropertyColumn Property="x => x.Description" Title="@SharedResource.Description" />
        <TemplateColumn Title="@SharedResource.Actions" Sortable="false" Filterable="false">
            <CellTemplate>
                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                              Color="Color.Primary" 
                              Size="Size.Small"
                              Href="@($"/rules/edit/{context.Item.Id}")" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                               Color="Color.Error" 
                               Size="Size.Small"
                               OnClick="@(() => DeleteRule(Guid.Parse(context.Item.Id)))" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {
    private MudDataGrid<RuleDto> dataGrid;

    private async Task<GridData<RuleDto>> LoadServerData(GridState<RuleDto> state)
    {

        var response = await RuleService.GetRules();

        return new GridData<RuleDto>
            {
                Items = response
            };
    }



    private async Task DeleteRule(Guid id)
    {
        try
        {
            await RuleService.DeleteRule(id);
            await dataGrid.ReloadServerData();
            Snackbar.Add(RulesRes.RuleDeletedSuccess, Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}
