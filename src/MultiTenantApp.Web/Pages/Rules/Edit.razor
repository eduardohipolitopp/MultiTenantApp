@page "/rules/edit/{Id}"
@using MultiTenantApp.Application.DTOs
@using MultiTenantApp.Web.Services
@using MultiTenantApp.Web.Resources.Pages
@using RulesRes = MultiTenantApp.Web.Resources.Pages.Rules
@inject IRuleService RuleService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">Edit Rule</MudText>

<MudPaper Class="pa-4">
    @if (model == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <EditForm Model="@model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            
            <MudTextField @bind-Value="model.Name" 
                          Label="Name" 
                          Required="true"
                          Variant="Variant.Outlined"
                          Class="mb-3" />
            
            <MudButton ButtonType="ButtonType.Submit" 
                       Variant="Variant.Filled" 
                       Color="Color.Primary">
                Update
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Secondary"
                       Href="/rules"
                       Class="ml-2">
                Cancel
            </MudButton>
        </EditForm>
    }
</MudPaper>

@code {
    [Parameter] public string Id { get; set; }

    private UpdateRuleDto model;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var ruleId = Guid.Parse(Id);
            var rule = await RuleService.GetRuleById(ruleId);
            
            if (rule != null)
            {
                model = new UpdateRuleDto { Name = rule.Name };
            }
            else
            {
                Snackbar.Add("Rule not found", Severity.Error);
                Navigation.NavigateTo("/rules");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading rule: {ex.Message}", Severity.Error);
            Navigation.NavigateTo("/rules");
        }
    }

    private async Task HandleSubmit()
    {
        try
        {
            var ruleId = Guid.Parse(Id);
            await RuleService.UpdateRule(ruleId, model);
            Snackbar.Add("Rule updated successfully", Severity.Success);
            Navigation.NavigateTo("/rules");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}
