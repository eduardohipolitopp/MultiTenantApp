@page "/rules/edit/{Id}"
@using MultiTenantApp.Application.DTOs
@using MultiTenantApp.Web.Services
@using MultiTenantApp.Web.Resources.Pages
@using MultiTenantApp.Web.Components.Rules
@using RulesRes = MultiTenantApp.Web.Resources.Pages.Rules
@inject IRuleService RuleService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">Edit Rule</MudText>

<MudPaper Class="pa-4">
    @if (roleName == null)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <RuleForm @bind-RoleName="roleName" ButtonText="Update" OnValidSubmit="Update" />
    }
</MudPaper>

@code {
    [Parameter] public string Id { get; set; }

    private string roleName;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Since we don't have GetById for Rules (Identity Roles), we might need to fetch all and filter
            // Or assume the Id passed is the Name if we were using Name as ID, but here ID is Guid usually.
            // Wait, RuleDto has Id and Name.
            // Let's fetch all rules and find by ID.
            var rules = await RuleService.GetRules();
            var rule = rules.FirstOrDefault(r => r.Id == Id);
            
            if (rule != null)
            {
                roleName = rule.Name;
            }
            else
            {
                Snackbar.Add("Rule not found", Severity.Error);
                Navigation.NavigateTo("/rules");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading rule: {ex.Message}", Severity.Error);
            Navigation.NavigateTo("/rules");
        }
    }

    private async Task Update()
    {
        try
        {
            var updateDto = new UpdateRuleDto { Name = roleName };
            await RuleService.UpdateRule(Id, updateDto);
            Snackbar.Add("Rule updated successfully", Severity.Success);
            Navigation.NavigateTo("/rules");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }
}
