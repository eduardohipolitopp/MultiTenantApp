@page "/register"
@using MultiTenantApp.Web.Services
@using Microsoft.Extensions.Configuration
@using MultiTenantApp.Web.Resources.Pages
@using MultiTenantApp.Web.Resources
@using RegisterRes = MultiTenantApp.Web.Resources.Pages.Register

@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IConfiguration Configuration
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Elevation="3" Class="pa-6">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">@RegisterRes.RegisterTitle</MudText>
        
        @if (!EnableSelfRegistration)
        {
            <MudAlert Severity="Severity.Warning">@SharedResource.SelfRegistrationDisabled</MudAlert>
        }
        else
        {
            <MudForm @ref="form" @bind-IsValid="@success">
                <MudTextField @bind-Value="registerModel.Email" 
                             Label="@SharedResource.Email" 
                             Variant="Variant.Outlined" 
                             Required="true"
                             Margin="Margin.Dense"
                             Class="mb-3" />

                <MudTextField @bind-Value="registerModel.Password" 
                             Label="@SharedResource.Password" 
                             Variant="Variant.Outlined" 
                             InputType="InputType.Password"
                             Required="true"
                             Margin="Margin.Dense"
                             Class="mb-3" />

                <MudTextField @bind-Value="registerModel.TenantId" 
                             Label="@SharedResource.TenantId" 
                             Variant="Variant.Outlined" 
                             Required="true"
                             Margin="Margin.Dense"
                             Class="mb-3" />

                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          FullWidth="true"
                          OnClick="HandleRegister"
                          Class="mb-3">
                    @SharedResource.Register
                </MudButton>
            </MudForm>
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-3">@errorMessage</MudAlert>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    private MudForm form;
    private bool success;
    private RegisterDto registerModel = new RegisterDto();
    private string errorMessage;
    private bool EnableSelfRegistration => Configuration.GetValue<bool>("EnableSelfRegistration");

    protected override void OnInitialized()
    {
        if (!EnableSelfRegistration)
        {
             // Optional logic
        }
    }

    private async Task HandleRegister()
    {
        await form.Validate();
        if (!success) return;

        try
        {
            await AuthService.RegisterAsync(registerModel);
            NavigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }
}
