@using MultiTenantApp.Web.Resources.Shared
@using NavMenuRes = MultiTenantApp.Web.Resources.Shared.NavMenu
@using MultiTenantApp.Web.Services
@using MultiTenantApp.Web.Interfaces
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject ThemeService ThemeService
@inject IProfileService ProfileService
@inject IFileService FileService

<MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" LockScroll="true">
    <ActivatorContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="cursor-pointer">
            <MudAvatar Size="Size.Medium">
                @if (!string.IsNullOrEmpty(avatarBase64DataUrl))
                {
                    <MudImage Src="@avatarBase64DataUrl" />
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Person" />
                }
            </MudAvatar>
            <MudText Typo="Typo.body1" Class="ml-2 mr-2">@UserName</MudText>
            <MudIcon Icon="@Icons.Material.Filled.ArrowDropDown" />
        </MudStack>
    </ActivatorContent>
    <ChildContent>
        <MudMenuItem Href="profile" Icon="@Icons.Material.Filled.Person">@NavMenuRes.Profile</MudMenuItem>
        <MudDivider />
        <MudMenuItem>
            <MudText Typo="Typo.body2" Class="mb-2">Theme</MudText>
            <MudGrid Spacing="1">
                @foreach (var color in new[] { "Blue", "Red", "Green", "Pink" })
                {
                    <MudItem xs="6">
                        <MudButton Variant="Variant.Filled" 
                                   Color="@GetColor(color)" 
                                   OnClick="@(() => SetTheme(color, false))"
                                   Class="rounded-circle"
                                   Style="width: 24px; height: 24px; min-width: 24px; padding: 0;" />
                        <MudButton Variant="Variant.Filled" 
                                   Color="@GetColor(color)" 
                                   OnClick="@(() => SetTheme(color, true))"
                                   Class="rounded-circle ml-1"
                                   Style="width: 24px; height: 24px; min-width: 24px; padding: 0; border: 2px solid #333;" />
                    </MudItem>
                }
            </MudGrid>
        </MudMenuItem>
        <MudDivider />
        <MudMenuItem OnClick="Logout" Icon="@Icons.Material.Filled.Logout">@NavMenuRes.Logout</MudMenuItem>
    </ChildContent>
</MudMenu>

@code {
    [Parameter] public string UserName { get; set; } = string.Empty;
    
    private string? avatarBase64DataUrl;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var profile = await ProfileService.GetMyProfileAsync();
            if (profile != null && !string.IsNullOrEmpty(profile.AvatarUrl))
            {
                // Fetch avatar as base64 data URL
                avatarBase64DataUrl = await FileService.GetFileAsBase64Async(profile.AvatarUrl);
            }
        }
        catch
        {
            // Ignore errors loading avatar
        }
    }

    private Color GetColor(string color)
    {
        return color switch
        {
            "Blue" => Color.Primary,
            "Red" => Color.Error,
            "Green" => Color.Success,
            "Pink" => Color.Secondary,
            _ => Color.Primary
        };
    }

    private async Task SetTheme(string color, bool isDark)
    {
        await ThemeService.SetThemeAsync(color, isDark);
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        NavigationManager.NavigateTo("/login", true);
    }
}
