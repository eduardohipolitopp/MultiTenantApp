@using Microsoft.AspNetCore.Components.Authorization
@using MultiTenantApp.Web.Interfaces
@using MultiTenantApp.Web.Extensions
@using System.Globalization
@using Blazored.LocalStorage
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IProfileService ProfileService
@inject ILocalStorageService LocalStorage

@code {
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // First try to get from local storage
            var cultureName = await LocalStorage.GetItemAsync<string>("culture");
            
            if (!string.IsNullOrEmpty(cultureName))
            {
                var cultureInfo = new CultureInfo(cultureName);
                CultureInfo.CurrentCulture = cultureInfo;
                CultureInfo.CurrentUICulture = cultureInfo;
            }
            else
            {
                // Fallback to profile setting if not in local storage
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;

                if (user.Identity?.IsAuthenticated == true)
                {
                    var profile = await ProfileService.GetMyProfileAsync();
                    if (profile != null)
                    {
                        var cultureInfo = profile.PreferredLanguage.ToCultureInfo();
                        
                        CultureInfo.CurrentCulture = cultureInfo;
                        CultureInfo.CurrentUICulture = cultureInfo;
                        
                        // Save to local storage for next time
                        await LocalStorage.SetItemAsync("culture", cultureInfo.Name);
                    }
                }
            }
        }
        catch
        {
            // Silently fail - use default culture
        }
    }
}
